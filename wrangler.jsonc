/**
 * For more details on how to configure Wrangler, refer to:
 * https://developers.cloudflare.com/workers/wrangler/configuration/
 */
{
    // Dev configuration - set enable_containers to false if Docker is not available
    // Preview sandboxes require Docker Desktop to be running
    "dev": {
        "enable_containers": true
    },
    "$schema": "node_modules/wrangler/config-schema.json",
    "name": "vibesdk-production",
    "main": "worker/index.ts",
    "compatibility_date": "2025-08-10",
    "compatibility_flags": [
        "nodejs_compat"
    ],
    "version_metadata": {
        "binding": "CF_VERSION_METADATA"
    },
    "assets": {
        "directory": "dist",
        "not_found_handling": "single-page-application",
        // "run_worker_first": ["!/src/*", "!/api/docs/*"],
        "run_worker_first": true,
        "binding": "ASSETS"
    },
    "observability": {
        "enabled": true,
        "head_sampling_rate": 1,
    },
    "unsafe": {
        "bindings": [
            {
                "name": "API_RATE_LIMITER",
                "type": "ratelimit",
                "namespace_id": "2101",
                "simple": {
                    "limit": 10000,
                    "period": 60
                }
            },
            {
                "name": "AUTH_RATE_LIMITER",
                "type": "ratelimit",
                "namespace_id": "2102",
                "simple": {
                    "limit": 1000,
                    "period": 60
                }
            }
        ]
    },
    /**
	 * Bindings
	 * Bindings allow your Worker to interact with resources on the Cloudflare Developer Platform, including
	 * databases, object storage, AI inference, real-time communication and more.
	 * https://developers.cloudflare.com/workers/runtime-apis/bindings/
	 */
    "ai": {
        "binding": "AI",
        "remote": true
    },
    // NOTE: dispatch_namespaces requires Workers for Platforms (paid subscription)
    // Uncomment the following for production deployment:
    // "dispatch_namespaces": [
    //     {
    //         "binding": "DISPATCHER",
    //         "namespace": "vibesdk-default-namespace",
    //         "remote": false
    //     }
    // ],
    "containers": [
        {
            "class_name": "UserAppSandboxService",
            "image": "./SandboxDockerfile",
            // "image": "registry.cloudflare.com/vibesdk-production-userappsandboxservice:cfe197fc",
            // Altering max_instances value will have no effect. Please use the MAX_SANDBOX_INSTANCES var instead.
            "max_instances": 1400,
            // ATTENTION: Altering instance_type value will have no effect. Please use the SANDBOX_INSTANCE_TYPE var instead.
            "instance_type": {
                "vcpu": 4,
                "memory_mib": 8192,
                "disk_mb": 10240
            },
            "rollout_step_percentage": 100
        }
    ],
    "d1_databases": [
        {
            "binding": "DB",
            "database_name": "vibesdk-db",
            "database_id": "local",
            "migrations_dir": "migrations",
            "remote": false
        }
    ],
    "durable_objects": {
        "bindings": [
            {
                "class_name": "CodeGeneratorAgent",
                "name": "CodeGenObject"
            },
            {
                "class_name": "UserAppSandboxService",
                "name": "Sandbox"
            },
            {
                "class_name": "DORateLimitStore",
                "name": "DORateLimitStore"
            },
            {
                "class_name": "UserSecretsStore",
                "name": "UserSecretsStore"
            }
        ]
    },
    "r2_buckets": [
        {
            "binding": "TEMPLATES_BUCKET",
            "bucket_name": "vibesdk-templates",
            "remote": false
        }
    ],
    "kv_namespaces": [
        {
            "binding": "VibecoderStore",
            "id": "local",
            "remote": false
        }
    ],
    // "placement": {
    //   "mode": "smart"
    // },
    "migrations": [
        {
            "new_sqlite_classes": [
                "CodeGeneratorAgent",
                "UserAppSandboxService"
            ],
            "tag": "v1"
        },
        {
            "new_sqlite_classes": [
                "DORateLimitStore"
            ],
            "tag": "v2"
        },
        {
            "new_sqlite_classes": [
                "UserSecretsStore"
            ],
            "tag": "v3"
        }
    ],
    "vars": {
        "ENVIRONMENT": "local",
        "TEMPLATES_REPOSITORY": "https://github.com/cloudflare/vibesdk-templates",
        "ALLOWED_EMAIL": "",
        "DISPATCH_NAMESPACE": "vibesdk-default-namespace",
        "ENABLE_READ_REPLICAS": "true",
        "CLOUDFLARE_AI_GATEWAY": "vibesdk-gateway",
        "CLOUDFLARE_AI_GATEWAY_URL": "none",
        "PLATFORM_CAPABILITIES": {
            "features": {
                "app": {
                    "enabled": true
                },
                "presentation": {
                    "enabled": false
                },
                "general": {
                    "enabled": false
                }
            },
            "version": "1.0.0"
        },
        "CUSTOM_DOMAIN": "localhost:5173",
        "MAX_SANDBOX_INSTANCES": "10",
        "SANDBOX_INSTANCE_TYPE": "standard-3"
    },
    "workers_dev": true,
    "preview_urls": true
}